{% extends 'webapp/base.html' %}

{% block title %}{{ assistant.model }} - Vision{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 fw-bold text-dark mb-1">
            <i class="bi bi-robot me-2"></i>
            {{ assistant.model }}
        </h1>
        <div class="d-flex align-items-center gap-3">
            <span class="badge bg-primary fs-6">
                <i class="bi bi-gear me-1"></i>{{ assistant.get_name_display }}
            </span>
            <small class="text-muted">Criado em {{ assistant.created_at|date:"d/m/Y H:i" }}</small>
        </div>
    </div>
    <div class="d-flex gap-2">
        <a href="{% url 'agents:assistant_list' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i>
            Voltar
        </a>
        <a href="{% url 'agents:assistant_edit' assistant.pk %}" class="btn btn-primary">
            <i class="bi bi-pencil me-1"></i>
            Editar
        </a>
        <a href="{% url 'agents:assistant_delete' assistant.pk %}" class="btn btn-outline-danger">
            <i class="bi bi-trash me-1"></i>
            Excluir
        </a>
    </div>
</div>

<div class="row">
    <!-- Main Information -->
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-info-circle me-2"></i>
                    Informações do Assistant
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Provedor de IA</label>
                        <div class="form-control-plaintext">{{ assistant.get_name_display }}</div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Modelo</label>
                        <div class="form-control-plaintext">{{ assistant.model }}</div>
                    </div>
                    <div class="col-12">
                        <label class="form-label fw-semibold">Instruções</label>
                        <div class="form-control-plaintext" style="white-space: pre-wrap;">{{ assistant.instructions }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Parameters -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-sliders me-2"></i>
                    Parâmetros de Geração
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Temperatura</label>
                        <div class="form-control-plaintext">{{ assistant.temperature }}</div>
                        <small class="text-muted">Controla a criatividade das respostas</small>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Máximo de Tokens</label>
                        <div class="form-control-plaintext">{{ assistant.max_tokens }}</div>
                        <small class="text-muted">Limite de tamanho da resposta</small>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Top-p</label>
                        <div class="form-control-plaintext">{{ assistant.top_p }}</div>
                        <small class="text-muted">Amostragem nuclear</small>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Penalidade de Presença</label>
                        <div class="form-control-plaintext">{{ assistant.presence_penalty }}</div>
                        <small class="text-muted">Evita repetição de tópicos</small>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Penalidade de Frequência</label>
                        <div class="form-control-plaintext">{{ assistant.frequency_penalty }}</div>
                        <small class="text-muted">Evita repetição de palavras</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Context Files -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-file-earmark-text me-2"></i>
                    Arquivos de Contexto
                </h5>
                <a href="{% url 'agents:context_file_upload' assistant.pk %}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-upload me-1"></i>Upload
                </a>
            </div>
            <div class="card-body">
                {% if assistant.context_files.all %}
                    <div class="row g-2">
                        {% for file in assistant.context_files.all|slice:":6" %}
                        <div class="col-md-6">
                            <div class="d-flex align-items-center p-2 border rounded">
                                <i class="bi bi-file-earmark-{% if file.file_type == 'pdf' %}pdf{% elif file.file_type == 'docx' %}word{% elif file.file_type == 'txt' or file.file_type == 'md' %}text{% elif file.file_type == 'csv' %}spreadsheet{% elif file.file_type == 'json' %}code{% else %}text{% endif %} me-2 text-primary"></i>
                                <div class="flex-grow-1">
                                    <div class="fw-semibold text-truncate" style="max-width: 120px;">{{ file.name }}</div>
                                    <div class="d-flex align-items-center gap-2">
                                        <small class="text-muted">{{ file.get_file_type_display }}</small>
                                        {% if file.status == 'ready' %}
                                            <span class="badge bg-success badge-sm">✓</span>
                                        {% elif file.status == 'processing' %}
                                            <span class="badge bg-warning badge-sm">⏳</span>
                                        {% elif file.status == 'error' %}
                                            <span class="badge bg-danger badge-sm">✗</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    {% if assistant.context_files.count > 6 %}
                    <div class="text-center mt-3">
                        <small class="text-muted">e mais {{ assistant.context_files.count|add:"-6" }} arquivo{{ assistant.context_files.count|add:"-6"|pluralize }}</small>
                    </div>
                    {% endif %}
                    
                    <div class="d-flex justify-content-between mt-3">
                        <a href="{% url 'agents:context_file_list' assistant.pk %}" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-list me-1"></i>Ver Todos
                        </a>
                        <a href="{% url 'agents:context_file_upload' assistant.pk %}" class="btn btn-sm btn-primary">
                            <i class="bi bi-upload me-1"></i>Adicionar Arquivo
                        </a>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-file-earmark-plus text-muted mb-2" style="font-size: 2rem;"></i>
                        <h6 class="text-muted">Nenhum arquivo de contexto</h6>
                        <p class="text-muted mb-3 small">Adicione documentos para personalizar as respostas do assistant</p>
                        <a href="{% url 'agents:context_file_upload' assistant.pk %}" class="btn btn-sm btn-primary">
                            <i class="bi bi-upload me-1"></i>Fazer Upload
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Usage Statistics -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-graph-up me-1"></i>
                    Estatísticas de Uso
                </h6>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>Instâncias usando:</span>
                            <span class="badge bg-secondary">{{ instances_using|default:0 }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Instances Using This Assistant -->
        {% if example_instances %}
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-phone me-1"></i>
                    Instâncias Usando
                </h6>
            </div>
            <div class="card-body">
                {% for instance in example_instances %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <div class="fw-semibold">{{ instance.name }}</div>
                        <small class="text-muted">{{ instance.instance_name }}</small>
                    </div>
                    <span class="badge status-{{ instance.status }}">
                        {% if instance.status == 'connected' %}
                            <i class="bi bi-check-circle me-1"></i>Conectada
                        {% elif instance.status == 'connecting' %}
                            <i class="bi bi-arrow-clockwise me-1"></i>Conectando
                        {% elif instance.status == 'disconnected' %}
                            <i class="bi bi-x-circle me-1"></i>Desconectada
                        {% elif instance.status == 'error' %}
                            <i class="bi bi-exclamation-triangle me-1"></i>Erro
                        {% endif %}
                    </span>
                </div>
                {% endfor %}
                {% if instances_using > example_instances|length %}
                <div class="text-center mt-3">
                    <small class="text-muted">e mais {{ instances_using|add:"-5" }} instância{{ instances_using|add:"-5"|pluralize }}</small>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Actions -->
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-gear me-1"></i>
                    Ações Rápidas
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'agents:assistant_edit' assistant.pk %}" class="btn btn-primary">
                        <i class="bi bi-pencil me-1"></i>
                        Editar Assistant
                    </a>
                    <a href="{% url 'whatsapp_connector:instance_create' %}" class="btn btn-outline-success">
                        <i class="bi bi-plus-circle me-1"></i>
                        Criar Instância com este Assistant
                    </a>
                    <a href="{% url 'agents:assistant_delete' assistant.pk %}" class="btn btn-outline-danger">
                        <i class="bi bi-trash me-1"></i>
                        Excluir Assistant
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}