{% extends 'webapp/base.html' %}

{% block title %}{{ instance.name }} - Orbi{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 fw-bold text-dark mb-1">
            <i class="bi bi-phone me-2"></i>
            {{ instance.name }}
        </h1>
        <div class="d-flex align-items-center gap-3">
            <span class="badge status-{{ instance.status }} fs-6">
                {% if instance.status == 'connected' %}
                    <i class="bi bi-check-circle me-1"></i>Conectada
                {% elif instance.status == 'connecting' %}
                    <i class="bi bi-arrow-clockwise me-1"></i>Conectando
                {% elif instance.status == 'disconnected' %}
                    <i class="bi bi-x-circle me-1"></i>Desconectada
                {% elif instance.status == 'error' %}
                    <i class="bi bi-exclamation-triangle me-1"></i>Erro
                {% endif %}
            </span>
            <small class="text-muted">{{ instance.instance_name }}</small>
        </div>
    </div>
    <div class="d-flex gap-2">
        <a href="{% url 'whatsapp_connector:instance_list' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i>
            Voltar
        </a>
        <a href="{% url 'whatsapp_connector:instance_edit' instance.pk %}" class="btn btn-outline-primary">
            <i class="bi bi-pencil me-1"></i>
            Editar
        </a>
        {% if instance.status == 'disconnected' %}
            <form method="post" action="{% url 'whatsapp_connector:instance_connect' instance.pk %}" class="d-inline">
                {% csrf_token %}
                <button type="submit" class="btn btn-success">
                    <i class="bi bi-play-circle me-1"></i>
                    Conectar
                </button>
            </form>
        {% elif instance.status == 'connected' %}
            <form method="post" action="{% url 'whatsapp_connector:instance_logout' instance.pk %}" class="d-inline">
                {% csrf_token %}
                <button type="submit" class="btn btn-warning">
                    <i class="bi bi-pause-circle me-1"></i>
                    Desconectar
                </button>
            </form>
        {% endif %}
        <a href="{% url 'whatsapp_connector:instance_webhook_config' instance.pk %}" class="btn btn-outline-info">
            <i class="bi bi-webhook me-1"></i>
            Webhook
        </a>
        <a href="{% url 'whatsapp_connector:instance_contacts_config' instance.pk %}" class="btn btn-outline-secondary">
            <i class="bi bi-person-lines-fill me-1"></i>
            Contatos
        </a>
        <form method="post" action="{% url 'whatsapp_connector:instance_delete' instance.pk %}" class="d-inline"
              onsubmit="return confirm('Tem certeza que deseja deletar esta instância?')">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">
                <i class="bi bi-trash me-1"></i>
                Deletar
            </button>
        </form>
    </div>
</div>

<div class="row">
    <!-- Instance Info -->
    <div class="col-lg-8">
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card stats-card success">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title text-white-50 mb-1">Mensagens</h6>
                                <h2 class="text-white fw-bold">{{ message_count }}</h2>
                            </div>
                            <i class="bi bi-chat-dots" style="font-size: 2rem; opacity: 0.7;"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card stats-card info">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title text-white-50 mb-1">Última Conexão</h6>
                                <h5 class="text-white fw-bold mb-0">
                                    {% if instance.last_connection %}
                                        {{ instance.last_connection|date:"d/m H:i" }}
                                    {% else %}
                                        Nunca
                                    {% endif %}
                                </h5>
                            </div>
                            <i class="bi bi-clock" style="font-size: 2rem; opacity: 0.7;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Connection Info -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-info-circle me-2"></i>
                    Informações da Conexão
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <td class="fw-semibold">Status:</td>
                                <td>
                                    <span class="badge status-{{ instance.status }}">
                                        {{ instance.get_status_display }}
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <td class="fw-semibold">Nome do Perfil:</td>
                                <td>{{ instance.profile_name|default:"-" }}</td>
                            </tr>
                            <tr>
                                <td class="fw-semibold">Número:</td>
                                <td>{{ instance.phone_number|default:"-" }}</td>
                            </tr>

                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <td class="fw-semibold">Criada em:</td>
                                <td>{{ instance.created_at|date:"d/m/Y H:i" }}</td>
                            </tr>
                            <tr>
                                <td class="fw-semibold">Atualizada:</td>
                                <td>{{ instance.updated_at|date:"d/m/Y H:i" }}</td>
                            </tr>
                            <tr>
                                <td class="fw-semibold">Ativa:</td>
                                <td>
                                    {% if instance.is_active %}
                                        <span class="badge bg-success">Sim</span>
                                    {% else %}
                                        <span class="badge bg-danger">Não</span>
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- QR Code Section -->
        {% if instance.status == 'disconnected' or instance.status == 'connecting' %}
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-qr-code me-2"></i>
                    QR Code para Conexão
                </h5>
                <div class="d-flex align-items-center gap-2">
                    <div class="timer-info">
                        <small class="text-muted">Próxima atualização em:</small>
                        <span class="badge bg-primary" id="timerCount">10s</span>
                    </div>
                    <button type="button" class="btn btn-outline-primary btn-sm" id="refreshQR">
                        <i class="bi bi-arrow-clockwise me-1"></i>
                        Atualizar Agora
                    </button>
                </div>
            </div>
            <div class="card-body text-center" id="qrContainer">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando QR Code...</span>
                </div>
                <p class="mt-3 text-muted">Obtendo QR Code...</p>
            </div>
        </div>
        {% endif %}

        <!-- Recent Messages -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-chat-left-text me-2"></i>
                    Mensagens Recentes
                </h5>
            </div>
            <div class="card-body p-0">
                {% if recent_messages %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>De</th>
                                    <th>Tipo</th>
                                    <th>Conteúdo</th>
                                    <th>Data</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for message in recent_messages %}
                                <tr>
                                    <td>
                                        <div>
                                            {% if message.sender_name %}
                                                <div class="fw-semibold">{{ message.sender_name }}</div>
                                            {% endif %}
                                            <small class="text-muted">{{ message.from_number }}</small>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge 
                                            {% if message.message_type == 'text' %}bg-primary
                                            {% elif message.message_type == 'image' %}bg-success
                                            {% elif message.message_type == 'audio' %}bg-warning
                                            {% else %}bg-secondary
                                            {% endif %}">
                                            {{ message.get_message_type_display }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if message.content %}
                                            <div class="text-truncate" style="max-width: 300px;">
                                                {{ message.content }}
                                            </div>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div>{{ message.received_at|date:"d/m/Y" }}</div>
                                        <small class="text-muted">{{ message.received_at|date:"H:i" }}</small>
                                    </td>
                                    <td>
                                        <span class="badge 
                                            {% if message.processing_status == 'completed' %}bg-success
                                            {% elif message.processing_status == 'processing' %}bg-warning
                                            {% elif message.processing_status == 'failed' %}bg-danger
                                            {% else %}bg-secondary
                                            {% endif %}">
                                            {{ message.get_processing_status_display }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-chat-square-dots text-muted mb-2" style="font-size: 3rem;"></i>
                        <h6 class="text-muted">Nenhuma mensagem ainda</h6>
                        <p class="text-muted small">As mensagens aparecerão aqui quando a instância estiver conectada.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Configuration -->
    <div class="col-lg-4">
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-gear me-1"></i>
                    Configuração
                </h6>
            </div>
            <div class="card-body">
                <table class="table table-sm table-borderless">
                    <tr>
                        <td class="fw-semibold">URL Base:</td>
                        <td class="text-break">{{ instance.base_url }}</td>
                    </tr>
{#                    <tr>#}
{#                        <td class="fw-semibold">API Key:</td>#}
{#                        <td>#}
{#                            <span class="font-monospace">{{ instance.api_key|slice:":10" }}...</span>#}
{#                        </td>#}
{#                    </tr>#}
                    <tr>
                        <td class="fw-semibold">Webhook:</td>
                        <td class="text-break">
                            {% if current_webhook.url %}
                                <div>
                                    <i class="bi bi-check-circle text-success me-1"></i>
                                    {{ current_webhook.url }}
                                </div>
                                <div class="small text-muted mt-1">
                                    Status: 
                                    {% if current_webhook.enabled %}
                                        <span class="badge bg-success">Ativo</span>
                                    {% else %}
                                        <span class="badge bg-warning">Inativo</span>
                                    {% endif %}
                                    | Eventos: {{ current_webhook.events|length }}
                                </div>
                            {% elif instance.webhook_url %}
                                <div>
                                    <i class="bi bi-exclamation-triangle text-warning me-1"></i>
                                    {{ instance.webhook_url }}
                                </div>
                                <div class="small text-warning">
                                    Configurado localmente, mas não confirmado na Evolution API
                                </div>
                            {% else %}
                                <span class="text-muted">
                                    <i class="bi bi-x-circle me-1"></i>
                                    Não configurado
                                </span>
                            {% endif %}
                        </td>
                    </tr>
                </table>
            </div>
        </div>

        {% if api_info %}
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-server me-1"></i>
                    Info da API
                </h6>
            </div>
            <div class="card-body">
                <pre class="small mb-0">{{ api_info|pprint }}</pre>
            </div>
        </div>
        {% endif %}

        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-lightning me-1"></i>
                    Ações Rápidas
                </h6>
            </div>
            <div class="card-body d-grid gap-2">
                <button type="button" class="btn btn-outline-primary" onclick="refreshStatus()">
                    <i class="bi bi-arrow-clockwise me-1"></i>
                    Atualizar Status
                </button>
                {% if instance.webhook_url %}
                <button type="button" class="btn btn-outline-info">
                    <i class="bi bi-link me-1"></i>
                    Testar Webhook
                </button>
                {% endif %}
                <a href="{% url 'admin:whatsapp_connector_evolutioninstance_change' instance.pk %}" 
                   class="btn btn-outline-secondary" target="_blank">
                    <i class="bi bi-pencil me-1"></i>
                    Editar no Admin
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let timerInterval;
let autoRefreshInterval;
let timeRemaining = 10;

document.addEventListener('DOMContentLoaded', function() {
    // Load QR Code on page load if needed
    {% if instance.status == 'disconnected' or instance.status == 'connecting' %}
        loadQRCode();
        startAutoRefresh();
    {% endif %}
    
    // Refresh QR Code button
    document.getElementById('refreshQR')?.addEventListener('click', function() {
        resetTimer();
        loadQRCode();
        refreshStatus();
    });
});

function startAutoRefresh() {
    // Start the countdown timer
    updateTimerDisplay();
    timerInterval = setInterval(() => {
        timeRemaining--;
        updateTimerDisplay();
        
        if (timeRemaining <= 0) {
            loadQRCode();
            refreshStatus();
            resetTimer();
        }
    }, 1000);
}

function resetTimer() {
    timeRemaining = 10;
    updateTimerDisplay();
    
    if (timerInterval) {
        clearInterval(timerInterval);
    }
    
    // Restart the timer if we're still on connecting/disconnected status
    {% if instance.status == 'disconnected' or instance.status == 'connecting' %}
        startAutoRefresh();
    {% endif %}
}

function updateTimerDisplay() {
    const timerElement = document.getElementById('timerCount');
    if (timerElement) {
        timerElement.textContent = `${timeRemaining}s`;
        
        // Change color based on time remaining
        timerElement.className = 'badge ' + (
            timeRemaining <= 5 ? 'bg-danger' : 
            timeRemaining <= 10 ? 'bg-warning' : 
            'bg-primary'
        );
    }
}

function loadQRCode() {
    const container = document.getElementById('qrContainer');
    container.innerHTML = `
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Carregando QR Code...</span>
        </div>
        <p class="mt-3 text-muted">Obtendo QR Code...</p>
    `;
    
    fetch(`{% url 'whatsapp_connector:instance_qr_code' instance.pk %}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                container.innerHTML = `
                    <div class="qr-code-container">
                        <img src="${data.qr_code}" alt="QR Code" class="img-fluid">
                        <p class="mt-3 text-muted">
                            <i class="bi bi-phone me-1"></i>
                            Escaneie com WhatsApp para conectar
                        </p>
                        <small class="text-muted d-block">
                            <i class="bi bi-clock me-1"></i>
                            QR Code atualizado automaticamente a cada 10 segundos
                        </small>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        ${data.message}
                        <div class="mt-2">
                            <small class="text-muted">Tentando novamente em 10 segundos...</small>
                        </div>
                    </div>
                `;
            }
        })
        .catch(error => {
            container.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-x-circle me-1"></i>
                    Erro ao carregar QR Code
                    <div class="mt-2">
                        <small class="text-muted">Tentando novamente em 10 segundos...</small>
                    </div>
                </div>
            `;
        });
}

function refreshStatus() {
    fetch(`{% url 'whatsapp_connector:instance_status' instance.pk %}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Check if status changed to connected
                if (data.status === 'connected') {
                    // Stop the timer if connected
                    if (timerInterval) {
                        clearInterval(timerInterval);
                    }
                    // Reload page to show connected status
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                }
            } else {
                console.log('Erro ao atualizar status:', data.error);
            }
        })
        .catch(error => {
            console.log('Erro na requisição de status');
        });
}

// Clean up intervals when leaving the page
window.addEventListener('beforeunload', function() {
    if (timerInterval) {
        clearInterval(timerInterval);
    }
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
});
</script>
{% endblock %}